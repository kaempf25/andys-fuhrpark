<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fahrzeugpark Andy</title>
    <!-- React und ReactDOM als UMD-Bundles -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel für In-Browser-Compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS für schnelles, buntes Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel">
      /* ----------------------------------------------------
         1) Beispiel-Daten (Garagen, Fahrzeuge, Wartungstasks)
      ----------------------------------------------------- */
      const garages = [
        "Spexarder_Strasse",
        "Sparkasse_Avenwedde",
        "Mumprow",
        "Amrumweg"
      ];

      const vehiclesDataInitial = [
        {
          id: "mercedes-w113",
          name: "Mercedes W113 230 SL (Pagode)",
          type: "Auto",
          technical: "Klassischer 230 SL mit 2,3-Liter Reihen-Sechszylinder und ca. 150 PS.",
          imageUrl: "./Mercedes w113.jpeg",
          marketPrice: "80.000€",
          garage: "Spexarder_Strasse",
          note: "",
          tuevDate: "", // Neues Feld für TÜV-Termin
          specs: {
            Motor: "2,3L Reihen-Sechszylinder",
            Leistung: "150 PS",
            Baujahr: "1963",
            Besonderheiten: "Ikonisches Pagoden-Design, zeitloses Erscheinungsbild"
          }
        },
        {
          id: "mercedes-r107",
          name: "Mercedes R107 560 SL",
          type: "Auto",
          technical: "Luxuriöses Cabriolet mit 5,6-Liter V8 und ca. 230 PS.",
          imageUrl: "./Mercedes R107.jpeg",
          marketPrice: "30.000€",
          garage: "Sparkasse_Avenwedde",
          note: "",
          tuevDate: "", // Neues Feld für TÜV-Termin
          specs: {
            Motor: "5,6L V8",
            Leistung: "230 PS",
            Baujahr: "1986",
            Besonderheiten: "Hochkomfort, klassisches Design, luxuriöse Ausstattung"
          }
        },
        {
          id: "anhaenger-2004",
          name: "Anhänger (2004)",
          type: "Anhänger",
          technical: "Nutzlastanhänger Baujahr 2004",
          imageUrl: "./anhaenger.jpg",
          marketPrice: "200€",
          garage: "Mumprow",
          note: "",
          tuevDate: "",
          specs: {
            Motor: "Ohne",
            Leistung: "-",
            Baujahr: "2004",
            Besonderheiten: "Nutzlast bis 750kg"
          }
        },
        // ... weitere Fahrzeuge ...
      ];

      const defaultMaintenanceTasks = [
        "Ölwechsel", 
        "Zündkerzen prüfen", 
        "Bremsen kontrollieren", 
        "Reifendruck prüfen"
      ];

      /* ----------------------------------------------------
         1.1) Hilfsfunktionen für TÜV-Erinnerungen und Benachrichtigungen
      ----------------------------------------------------- */

      // Prüft, ob der TÜV innerhalb des nächsten Monats fällig ist
      const isTuevDueSoon = (tuevDate) => {
        if (!tuevDate) return false;
        
        const today = new Date();
        const tuev = new Date(tuevDate);
        
        // Setze Vergleichsdatum auf 1 Monat in der Zukunft
        const oneMonthLater = new Date();
        oneMonthLater.setMonth(today.getMonth() + 1);
        
        // TÜV ist fällig, wenn das Datum zwischen heute und in einem Monat liegt
        return tuev >= today && tuev <= oneMonthLater;
      };

      // Prüft, ob wir Browser-Benachrichtigungen senden können
      const canSendNotifications = () => {
        return "Notification" in window;
      };

      // Fordert Benachrichtigungsberechtigungen an
      const requestNotificationPermission = async () => {
        if (!canSendNotifications()) return false;
        
        const permission = await Notification.requestPermission();
        return permission === "granted";
      };

      // Sendet eine Browser-Benachrichtigung
      const sendNotification = (title, options) => {
        if (Notification.permission === "granted") {
          new Notification(title, options);
          return true;
        }
        return false;
      };

      // Erstellt einen E-Mail-Link mit vorbefülltem Inhalt
      const createTuevEmailLink = (vehicle) => {
        const subject = `TÜV-Erinnerung: ${vehicle.name}`;
        const body = `Der TÜV für Ihr Fahrzeug ${vehicle.name} ist am ${new Date(vehicle.tuevDate).toLocaleDateString()} fällig.`;
        return `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      };

      /* ----------------------------------------------------
         2) Haupt-App-Komponente
      ----------------------------------------------------- */
      function FuhrparkApp() {
        // -- Haupt-State für Fahrzeuge und Wartungen --
        const [vehiclesData, setVehiclesData] = React.useState(() => {
          const savedData = localStorage.getItem("vehiclesData");
          return savedData ? JSON.parse(savedData) : vehiclesDataInitial;
        });

        const [maintenanceData, setMaintenanceData] = React.useState(() => {
          const savedData = localStorage.getItem("maintenanceData");
          return savedData ? JSON.parse(savedData) : {};
        });

        const [maintenanceTasks, setMaintenanceTasks] = React.useState(() => {
          const savedTasks = localStorage.getItem("maintenanceTasks");
          return savedTasks ? JSON.parse(savedTasks) : defaultMaintenanceTasks;
        });

        const [maintenanceRecords, setMaintenanceRecords] = React.useState(() => {
          const savedRecords = localStorage.getItem("maintenanceRecords");
          return savedRecords ? JSON.parse(savedRecords) : {};
        });

        // -- Filter und Modals --
        const [filterType, setFilterType] = React.useState("Alle");
        const [selectedYear, setSelectedYear] = React.useState(2025);
        const [selectedVehicleId, setSelectedVehicleId] = React.useState(null);
        const [showMaintenanceModalId, setShowMaintenanceModalId] = React.useState(null);
        const [showAllMaintenanceHistory, setShowAllMaintenanceHistory] = React.useState(false);
        const [showTuevReminders, setShowTuevReminders] = React.useState(false);
        const [notificationsPermission, setNotificationsPermission] = React.useState(
          Notification.permission === "granted"
        );

        // -- Effekte: lokale Speicherung + (optionales) Server-Log --
        React.useEffect(() => {
          localStorage.setItem("vehiclesData", JSON.stringify(vehiclesData));
        }, [vehiclesData]);

        React.useEffect(() => {
          localStorage.setItem("maintenanceData", JSON.stringify(maintenanceData));
          saveToServer("maintenanceData", maintenanceData);
        }, [maintenanceData]);

        React.useEffect(() => {
          localStorage.setItem("maintenanceTasks", JSON.stringify(maintenanceTasks));
        }, [maintenanceTasks]);

        React.useEffect(() => {
          localStorage.setItem("maintenanceRecords", JSON.stringify(maintenanceRecords));
          saveToServer("maintenanceRecords", maintenanceRecords);
        }, [maintenanceRecords]);

        // -- Überprüfung auf fällige TÜV-Termine bei Laden und in Intervallen --
        React.useEffect(() => {
          // Prüfe fällige TÜV-Termine, wenn die App geladen wird
          checkTuevDates();

          // Prüfe täglich auf fällige TÜV-Termine
          const interval = setInterval(checkTuevDates, 24 * 60 * 60 * 1000);

          return () => clearInterval(interval);
        }, [vehiclesData]);

        // -- Effekt: Frage nach Benachrichtigungsberechtigung --
        React.useEffect(() => {
          const askForNotificationPermission = async () => {
            if (canSendNotifications() && Notification.permission === "default") {
              const granted = await requestNotificationPermission();
              setNotificationsPermission(granted);
            }
          };
          
          askForNotificationPermission();
        }, []);

        // -- Prüfe TÜV-Termine und zeige Benachrichtigungen --
        const checkTuevDates = () => {
          const dueSoonVehicles = vehiclesData.filter(
            vehicle => vehicle.tuevDate && isTuevDueSoon(vehicle.tuevDate)
          );

          if (dueSoonVehicles.length > 0) {
            // Zeige Banner in der App
            setShowTuevReminders(true);

            // Sende Browser-Benachrichtigungen, wenn erlaubt
            if (notificationsPermission) {
              dueSoonVehicles.forEach(vehicle => {
                const tuevDate = new Date(vehicle.tuevDate).toLocaleDateString();
                sendNotification(`TÜV fällig: ${vehicle.name}`, {
                  body: `Der TÜV für ${vehicle.name} ist am ${tuevDate} fällig.`,
                  icon: vehicle.imageUrl
                });
              });
            }
          }
        };

        // -- Mock: "Speichern auf dem Server" --
        const saveToServer = (dataType, data) => {
          console.log(`Speichere ${dataType} auf dem Server:`, data);
          // Optional: Download-Simulation
          // const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          // const url = URL.createObjectURL(blob);
          // const a = document.createElement('a');
          // a.href = url;
          // a.download = `${dataType}.json`;
          // a.click();
        };

        // -- Modals schließen --
        const closeModal = () => {
          setSelectedVehicleId(null);
          setShowMaintenanceModalId(null);
          setShowAllMaintenanceHistory(false);
        };

        // -- TÜV-Erinnerungsbanner schließen --
        const closeTuevReminders = () => {
          setShowTuevReminders(false);
        };

        // -- MaintenanceTask hinzufügen (global) --
        const handleAddMaintenanceTask = () => {
          const newTask = prompt("Neuen Wartungsdienst eingeben:");
          if (newTask && newTask.trim()) {
            setMaintenanceTasks((prev) => [...prev, newTask.trim()]);
          }
        };

        // -- Checkbox an- und abwählen (Ölwechsel, etc.) --
        const handleTaskToggle = (vehicleId, year, task) => {
          setMaintenanceData((prev) => {
            const vehicleData = prev[vehicleId] || {};
            const yearData = vehicleData[year] || {};
            const currentStatus = yearData[task];
            const newYearData = {
              ...yearData,
              [task]: currentStatus ? null : new Date().toISOString()
            };
            return {
              ...prev,
              [vehicleId]: {
                ...vehicleData,
                [year]: newYearData
              }
            };
          });
        };

        // -- Wartungshistorie manuell hinzufügen (aus Modal heraus) --
        const addMaintenanceRecordGlobal = (vehicleId, record) => {
          setMaintenanceRecords((prev) => {
            const currentRecords = prev[vehicleId] || [];
            return {
              ...prev,
              [vehicleId]: [...currentRecords, record]
            };
          });
        };

        // -- Bild hochladen (global) --
        const handleImageUpload = (e, vehicleId) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
              const newImageUrl = reader.result;
              setVehiclesData((prev) =>
                prev.map((vehicle) =>
                  vehicle.id === vehicleId ? { ...vehicle, imageUrl: newImageUrl } : vehicle
                )
              );
            };
            reader.readAsDataURL(file);
          }
        };

        // -- Notiz ändern (global) --
        const handleNoteChange = (vehicleId, newNote) => {
          setVehiclesData((prev) =>
            prev.map((vehicle) =>
              vehicle.id === vehicleId ? { ...vehicle, note: newNote } : vehicle
            )
          );
        };

        // -- TÜV-Datum ändern (global) --
        const handleTuevDateChange = (vehicleId, newTuevDate) => {
          setVehiclesData((prev) =>
            prev.map((vehicle) =>
              vehicle.id === vehicleId ? { ...vehicle, tuevDate: newTuevDate } : vehicle
            )
          );
        };

        // -- Marktpreis oder Garage ändern (global) --
        const handleVehicleUpdate = (vehicleId, updates) => {
          setVehiclesData((prev) =>
            prev.map((vehicle) =>
              vehicle.id === vehicleId ? { ...vehicle, ...updates } : vehicle
            )
          );
        };

        // -- Modals öffnen --
        const openVehicleDetails = (vehicleId) => {
          setSelectedVehicleId(vehicleId);
        };

        const openMaintenanceModal = (vehicleId, e) => {
          e.stopPropagation();
          setShowMaintenanceModalId(vehicleId);
        };

        const openAllMaintenanceHistory = () => {
          setShowAllMaintenanceHistory(true);
        };

        // -- Jahresliste --
        const years = [];
        for (let y = 2025; y <= 2050; y++) {
          years.push(y);
        }

        // -- Filterung --
        const filteredVehicles = vehiclesData.filter((v) =>
          filterType === "Alle" ? true : v.type === filterType
        );

        // -- Selektion --
        const selectedVehicle = vehiclesData.find((v) => v.id === selectedVehicleId);
        const maintenanceModalVehicle = vehiclesData.find((v) => v.id === showMaintenanceModalId);

        // -- TÜV-relevante Daten --
        const vehiclesWithUpcomingTuev = vehiclesData.filter(
          vehicle => vehicle.tuevDate && isTuevDueSoon(vehicle.tuevDate)
        );

        // -- Gesamte Wartungshistorie (Tabelle) --
        const allMaintenanceEntries = [];

        // CheckBox-basierte Wartungen
        Object.entries(maintenanceData).forEach(([vehicleId, yearData]) => {
          const vehicle = vehiclesData.find((v) => v.id === vehicleId);
          if (!vehicle) return;
          Object.entries(yearData).forEach(([year, tasks]) => {
            Object.entries(tasks).forEach(([taskName, completedDate]) => {
              if (completedDate) {
                allMaintenanceEntries.push({
                  vehicleId,
                  vehicleName: vehicle.name,
                  year,
                  task: taskName,
                  date: new Date(completedDate),
                  type: "checkbox"
                });
              }
            });
          });
        });

        // Manuelle Wartungseinträge
        Object.entries(maintenanceRecords).forEach(([vehicleId, records]) => {
          const vehicle = vehiclesData.find((v) => v.id === vehicleId);
          if (!vehicle) return;
          records.forEach((record) => {
            allMaintenanceEntries.push({
              vehicleId,
              vehicleName: vehicle.name,
              task: record.task,
              date: new Date(record.date),
              type: "manual"
            });
          });
        });

        // Sortieren (neueste zuerst)
        allMaintenanceEntries.sort((a, b) => b.date - a.date);

        // -- RENDER --
        return (
          <div className="container mx-auto p-4">
            {/* HEADER */}
            <header className="w-full max-w-4xl py-4 mx-auto">
              <h1 className="text-4xl font-extrabold text-center bg-gradient-to-r from-purple-600 to-pink-500 text-white py-4 rounded">
                Fahrzeugpark Andy
              </h1>
              <div className="flex justify-between items-center mt-4">
                <div className="flex items-center space-x-3">
                  <label className="font-semibold">Fahrzeugtyp:</label>
                  <select
                    value={filterType}
                    onChange={(e) => setFilterType(e.target.value)}
                    className="border rounded px-2 py-1"
                  >
                    <option value="Alle">Alle</option>
                    <option value="Auto">Auto</option>
                    <option value="Motorrad">Motorrad</option>
                    <option value="Roller">Roller</option>
                    <option value="Landmaschine">Landmaschine</option>
                    <option value="Anhänger">Anhänger</option>
                  </select>
                </div>
                <div className="flex space-x-2">
                  <button
                    onClick={openAllMaintenanceHistory}
                    className="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"
                  >
                    Gesamte Wartungshistorie
                  </button>
                  <button
                    onClick={() => requestNotificationPermission().then(setNotificationsPermission)}
                    className={`py-2 px-4 rounded ${
                      notificationsPermission 
                        ? "bg-green-600 hover:bg-green-700" 
                        : "bg-yellow-500 hover:bg-yellow-600"
                    } text-white`}
                    title={
                      notificationsPermission
                        ? "Benachrichtigungen sind aktiviert"
                        : "Benachrichtigungen aktivieren"
                    }
                  >
                    {notificationsPermission ? "Benachrichtigungen ✓" : "Benachrichtigungen aktivieren"}
                  </button>
                </div>
              </div>
            </header>

            {/* TÜV-ERINNERUNGEN BANNER */}
            {showTuevReminders && vehiclesWithUpcomingTuev.length > 0 && (
              <div className="w-full max-w-4xl mx-auto mb-6">
                <div className="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded shadow-md relative">
                  <button
                    onClick={closeTuevReminders}
                    className="absolute top-2 right-2 text-gray-600 hover:text-gray-800"
                  >
                    &times;
                  </button>
                  <h3 className="text-xl font-bold text-yellow-800 mb-2">
                    TÜV-Erinnerung
                  </h3>
                  <p className="mb-3">Die folgenden Fahrzeuge haben bald TÜV-Termine:</p>
                  <ul className="space-y-2">
                    {vehiclesWithUpcomingTuev.map((vehicle) => (
                      <li key={vehicle.id} className="flex justify-between items-center">
                        <div>
                          <span className="font-semibold">{vehicle.name}:</span>{" "}
                          <span className="text-yellow-700">
                            {new Date(vehicle.tuevDate).toLocaleDateString()}
                          </span>
                        </div>
                        <div>
                          <a
                            href={createTuevEmailLink(vehicle)}
                            className="text-blue-600 hover:text-blue-800 underline text-sm ml-4"
                            target="_blank"
                            rel="noopener noreferrer"
                          >
                            E-Mail-Erinnerung senden
                          </a>
                        </div>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            )}

            {/* FAHRZEUG-ÜBERSICHT */}
            <main className="w-full max-w-4xl mx-auto">
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                {filteredVehicles.map((vehicle) => (
                  <VehicleCard
                    key={vehicle.id}
                    vehicle={vehicle}
                    onClick={() => openVehicleDetails(vehicle.id)}
                    onMaintenanceClick={(e) => openMaintenanceModal(vehicle.id, e)}
                    isTuevDueSoon={vehicle.tuevDate && isTuevDueSoon(vehicle.tuevDate)}
                  />
                ))}
              </div>

              {/* KURZ-ÜBERSICHT WARTUNGEN */}
              <div className="bg-white rounded-lg shadow-md p-4 mb-6">
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-xl font-bold text-blue-800">Übersicht: Anstehende Wartungen</h2>
                  <div className="flex items-center">
                    <label className="mr-2">Jahr:</label>
                    <select
                      value={selectedYear}
                      onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                      className="border rounded px-2 py-1 text-sm"
                    >
                      {years.map((y) => (
                        <option key={y} value={y}>
                          {y}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>

                <div className="overflow-x-auto">
                  <table className="min-w-full border-collapse">
                    <thead>
                      <tr className="bg-gray-100">
                        <th className="p-2 text-left border">Fahrzeug</th>
                        {maintenanceTasks.map((task) => (
                          <th key={task} className="p-2 text-left border">
                            {task}
                          </th>
                        ))}
                        <th className="p-2 text-left border">TÜV</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredVehicles.map((vehicle) => {
                        const vehicleData = maintenanceData[vehicle.id] || {};
                        const yearData = vehicleData[selectedYear] || {};
                        return (
                          <tr key={vehicle.id} className="hover:bg-gray-50">
                            <td className="p-2 border font-medium">{vehicle.name}</td>
                            {maintenanceTasks.map((task) => {
                              const isComplete = !!yearData[task];
                              return (
                                <td key={task} className="p-2 border text-center">
                                  <span className={isComplete ? "text-green-600" : "text-red-600"}>
                                    {isComplete ? "✓" : "✗"}
                                  </span>
                                </td>
                              );
                            })}
                            <td className="p-2 border text-center">
                              {vehicle.tuevDate ? (
                                <span className={isTuevDueSoon(vehicle.tuevDate) ? "text-yellow-600 font-bold" : ""}>
                                  {new Date(vehicle.tuevDate).toLocaleDateString()}
                                </span>
                              ) : (
                                <span className="text-gray-400">Nicht eingetragen</span>
                              )}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>

                <div className="mt-3 text-right">
                  <button
                    onClick={handleAddMaintenanceTask}
                    className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700"
                  >
                    Wartungsdienst hinzufügen
                  </button>
                </div>
              </div>
            </main>

            {/* MODALS */}
            {selectedVehicle && (
              <VehicleDetailsModal
                vehicle={selectedVehicle}
                onClose={closeModal}
                garages={garages}
                onImageUpload={handleImageUpload}
                onUpdateVehicle={handleVehicleUpdate}
                onNoteChange={handleNoteChange}
                onTuevDateChange={handleTuevDateChange}
              />
            )}

            {maintenanceModalVehicle && (
              <MaintenanceModal
                vehicle={maintenanceModalVehicle}
                year={selectedYear}
                setYear={setSelectedYear}
                tasks={maintenanceTasks}
                maintenanceData={maintenanceData}
                onToggleTask={handleTaskToggle}
                onClose={closeModal}
                onAddMaintenanceRecord={addMaintenanceRecordGlobal}
              />
            )}

            {showAllMaintenanceHistory && (
              <AllMaintenanceHistoryModal
                entries={allMaintenanceEntries}
                onClose={closeModal}
              />
            )}

            {/* FOOTER */}
            <footer className="w-full max-w-4xl mx-auto mt-8 py-4 text-center text-gray-500 text-sm">
              <p>© {new Date().getFullYear()} Andys Fuhrpark - Alle Rechte vorbehalten</p>
              <p>Version 1.1.0</p>
            </footer>
          </div>
        );
      }

      /* ----------------------------------------------------
         3) Komponenten: VehicleCard, VehicleDetailsModal, etc.
      ----------------------------------------------------- */

      // -- Fahrzeug-Karte --
      function VehicleCard({ vehicle, onClick, onMaintenanceClick, isTuevDueSoon }) {
        return (
          <div
            className="border rounded-lg shadow-lg p-4 bg-gradient-to-br from-blue-100 to-purple-100 relative cursor-pointer"
            onClick={onClick}
          >
            <img src={vehicle.imageUrl} alt={vehicle.name} className="w-full h-40 object-cover rounded" />
            <h2 className="text-xl font-bold mt-2 text-blue-800">{vehicle.name}</h2>
            <p className="text-sm text-gray-700">{vehicle.technical}</p>
            <div className="mt-2 text-sm text-gray-800">
              <p>
                <strong>Motor:</strong> {vehicle.specs?.Motor}
              </p>
              <p>
                <strong>Leistung:</strong> {vehicle.specs?.Leistung}
              </p>
              <p>
                <strong>Baujahr:</strong> {vehicle.specs?.Baujahr}
              </p>
              <p>
                <strong>Besonderheiten:</strong> {vehicle.specs?.Besonderheiten}
              </p>
            </div>
            <div className="mt-2 text-sm">
              <p>
                <strong>Marktpreis:</strong> {vehicle.marketPrice}
              </p>
              <p>
                <strong>Garage:</strong> {vehicle.garage?.replace(/_/g, " ")}
              </p>
              {vehicle.tuevDate && (
                <p className={isTuevDueSoon ? "font-bold text-yellow-700" : ""}>
                  <strong>TÜV:</strong> {new Date(vehicle.tuevDate).toLocaleDateString()}
                  {isTuevDueSoon && " (bald fällig!)"}
                </p>
              )}
            </div>
            <button
              onClick={onMaintenanceClick}
              className="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded-full shadow-md hover:bg-green-600"
            >
              Wartung
            </button>
            {isTuevDueSoon && (
              <div className="absolute top-2 left-2 bg-yellow-500 text-white px-2 py-1 rounded-full shadow-md">
                TÜV!
              </div>
            )}
          </div>
        );
      }

      // -- Modal: Fahrzeugdetails (Preis, Garage, Notizen, Bild und neu: TÜV-Termin) --
      function VehicleDetailsModal({
        vehicle,
        onClose,
        garages,
        onImageUpload,
        onUpdateVehicle,
        onNoteChange,
        onTuevDateChange
      }) {
        // Lokale States für Eingabefelder
        const [localPrice, setLocalPrice] = React.useState(vehicle.marketPrice || "");
        const [localGarage, setLocalGarage] = React.useState(vehicle.garage || "");
        const [localNote, setLocalNote] = React.useState(vehicle.note || "");
        const [localTuevDate, setLocalTuevDate] = React.useState(vehicle.tuevDate || "");

        // Formatiere TÜV-Datum für HTML-Datumseingabe
        const formatDateForInput = (dateString) => {
          if (!dateString) return "";
          const date = new Date(dateString);
          return date.toISOString().split('T')[0];
        };

        // Wird aufgerufen, wenn Nutzer „Speichern & Schließen" klickt
        const handleSaveAndClose = () => {
          onUpdateVehicle(vehicle.id, {
            marketPrice: localPrice,
            garage: localGarage
          });
          onNoteChange(vehicle.id, localNote);
          onTuevDateChange(vehicle.id, localTuevDate);
          onClose();
        };

        return (
          <div className="fixed inset-0 flex items-center justify-center z-50">
            {/* Overlay */}
            <div className="absolute inset-0 bg-black opacity-50" onClick={onClose}></div>
            <div className="relative bg-white rounded-lg p-6 w-11/12 max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl">
              <button onClick={onClose} className="absolute top-2 right-2 text-red-600 font-bold text-xl">
                &times;
              </button>
              <h2 className="text-2xl font-bold mb-4">{vehicle.name}</h2>
              <img
                src={vehicle.imageUrl}
                alt={vehicle.name}
                className="w-full h-64 object-contain mb-4 border rounded"
              />
              <div className="space-y-4">
                <div>
                  <label className="block font-semibold mb-1">Marktpreis:</label>
                  <input
                    type="text"
                    value={localPrice}
                    onChange={(e) => setLocalPrice(e.target.value)}
                    className="border rounded px-3 py-2 w-full"
                  />
                </div>
                <div>
                  <label className="block font-semibold mb-1">Garage:</label>
                  <select
                    value={localGarage}
                    onChange={(e) => setLocalGarage(e.target.value)}
                    className="border rounded px-3 py-2 w-full"
                  >
                    {garages.map((g, idx) => (
                      <option key={idx} value={g}>
                        {g.replace(/_/g, " ")}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block font-semibold mb-1">TÜV-Termin:</label>
                  <input
                    type="date"
                    value={formatDateForInput(localTuevDate)}
                    onChange={(e) => setLocalTuevDate(e.target.value)}
                    className="border rounded px-3 py-2 w-full"
                  />
                  {isTuevDueSoon(localTuevDate) && (
                    <p className="text-yellow-600 text-sm mt-1">
                      Dieser TÜV-Termin ist innerhalb des nächsten Monats fällig!
                    </p>
                  )}
                </div>
                <div>
                  <label className="block font-semibold mb-1">Notizen:</label>
                  <textarea
                    value={localNote}
                    onChange={(e) => setLocalNote(e.target.value)}
                    className="w-full border rounded p-2 h-24"
                    placeholder="Notizen zum Fahrzeug..."
                  />
                </div>
                <div>
                  <label className="block font-semibold mb-1">Foto ändern:</label>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => onImageUpload(e, vehicle.id)}
                    className="w-full"
                  />
                </div>
                <button
                  onClick={handleSaveAndClose}
                  className="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700"
                >
                  Speichern und schließen
                </button>
              </div>
            </div>
          </div>
        );
      }

      // -- Modal: Wartung (Checklisten-Tasks + optional neue Wartung eintragen) --
      function MaintenanceModal({
        vehicle,
        year,
        setYear,
        tasks,
        maintenanceData,
        onToggleTask,
        onClose,
        onAddMaintenanceRecord
      }) {
        // Lokaler State für neue Wartungseinträge
        const [localTask, setLocalTask] = React.useState("");
        const [localDate, setLocalDate] = React.useState("");

        // Beim Klick auf „Hinzufügen & schließen"
        const handleAddRecordAndClose = () => {
          // Wenn beides ausgefüllt ist, speichern wir es
          if (localTask && localDate) {
            const record = {
              task: localTask,
              date: localDate,
              timestamp: new Date().toISOString()
            };
            onAddMaintenanceRecord(vehicle.id, record);
          }
          // Egal ob ausgefüllt oder nicht -> Modal zu
          onClose();
        };

        return (
          <div className="fixed inset-0 flex items-center justify-center z-50">
            <div className="absolute inset-0 bg-black opacity-50" onClick={onClose}></div>
            <div className="relative bg-white rounded-lg p-6 w-11/12 max-w-lg shadow-2xl">
              <button onClick={onClose} className="absolute top-2 right-2 text-red-600 font-bold text-xl">
                &times;
              </button>
              <h2 className="text-2xl font-bold mb-4 text-blue-800">
                Wartung: {vehicle.name}
              </h2>
              <div className="mb-4">
                <label className="mr-2 font-semibold">Jahr:</label>
                <select
                  value={year}
                  onChange={(e) => setYear(parseInt(e.target.value))}
                  className="border rounded px-2 py-1"
                >
                  {[...Array(26)].map((_, i) => {
                    const y = 2025 + i;
                    return (
                      <option key={y} value={y}>
                        {y}
                      </option>
                    );
                  })}
                </select>
              </div>
              {/* Checkliste */}
              <div className="mb-6 bg-gray-50 p-4 rounded shadow">
                <h3 className="text-lg font-bold mb-3">Wartungstasks {year}</h3>
                <ul className="space-y-2">
                  {tasks.map((task) => {
                    const vehicleMaintenanceData = maintenanceData[vehicle.id] || {};
                    const yearData = vehicleMaintenanceData[year] || {};
                    const completedDate = yearData[task];
                    return (
                      <li key={task} className="flex items-center">
                        <input
                          type="checkbox"
                          checked={!!completedDate}
                          onChange={() => onToggleTask(vehicle.id, year, task)}
                          className="mr-3 h-5 w-5"
                        />
                        <span className={completedDate ? "line-through text-green-600" : ""}>
                          {task}
                        </span>
                        {completedDate && (
                          <span className="ml-2 text-sm text-green-600">
                            (am {new Date(completedDate).toLocaleDateString()})
                          </span>
                        )}
                      </li>
                    );
                  })}
                </ul>
              </div>
              {/* Neue Wartung eintragen */}
              <div className="mb-4 border-t pt-4">
                <h3 className="text-lg font-bold mb-2">
                  Neue Wartung eintragen (optional)
                </h3>
                <div className="flex flex-col space-y-2">
                  <input
                    type="text"
                    placeholder="Wartungsdienst beschreiben..."
                    value={localTask}
                    onChange={(e) => setLocalTask(e.target.value)}
                    className="border rounded px-3 py-2"
                  />
                  <input
                    type="date"
                    value={localDate}
                    onChange={(e) => setLocalDate(e.target.value)}
                    className="border rounded px-3 py-2"
                  />
                  <button
                    onClick={handleAddRecordAndClose}
                    className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                  >
                    Wartung hinzufügen &amp; schließen
                  </button>
                </div>
              </div>
              {/* Wartungshistorie für dieses Fahrzeug */}
              {/* (maintenanceRecords liegt in FuhrparkApp, wir reichen es hier ggf. nur über props durch, 
                  oder wir lassen es weg. Falls du es brauchst, kannst du es analog zum Task-Check abfragen.) */}
            </div>
          </div>
        );
      }

      // -- Modal: Gesamte Wartungshistorie --
      function AllMaintenanceHistoryModal({ entries, onClose }) {
        return (
          <div className="fixed inset-0 flex items-center justify-center z-50">
            <div className="absolute inset-0 bg-black opacity-50" onClick={onClose}></div>
            <div className="relative bg-white rounded-lg p-6 w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl">
              <button
                onClick={onClose}
                className="absolute top-2 right-2 text-red-600 font-bold text-xl"
              >
                &times;
              </button>
              <h2 className="text-2xl font-bold mb-4 text-blue-800">
                Gesamte Wartungshistorie
              </h2>
              <div className="border rounded shadow">
                <table className="w-full text-sm">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="p-2 text-left">Datum</th>
                      <th className="p-2 text-left">Fahrzeug</th>
                      <th className="p-2 text-left">Wartungsdienst</th>
                      <th className="p-2 text-left">Art</th>
                    </tr>
                  </thead>
                  <tbody>
                    {entries.map((entry, index) => (
                      <tr
                        key={index}
                        className={index % 2 === 0 ? "bg-gray-50" : ""}
                      >
                        <td className="p-2 border-t">
                          {entry.date.toLocaleDateString()}
                        </td>
                        <td className="p-2 border-t">{entry.vehicleName}</td>
                        <td className="p-2 border-t">{entry.task}</td>
                        <td className="p-2 border-t">
                          {entry.type === "checkbox" ? "Standard" : "Manuell"}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              {entries.length === 0 && (
                <p className="text-center p-4 text-gray-500">
                  Keine Wartungsdaten vorhanden
                </p>
              )}
            </div>
          </div>
        );
      }

      /* ----------------------------------------------------
         4) App in DOM rendern
      ----------------------------------------------------- */
      ReactDOM.render(<FuhrparkApp />, document.getElementById("root"));
    </script>
  </body>
</html>
