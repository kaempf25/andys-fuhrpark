<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fahrzeugpark Andy</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Allgemeine Stile */
        body {
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Fahrzeugkarte */
        .vehicle-card {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            background: linear-gradient(to bottom right, #e0f2fe, #f3e8ff);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .vehicle-card:active {
            transform: scale(0.98);
        }
        
        /* Bilder */
        .vehicle-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 0.375rem;
            background-color: #f3f4f6;
        }
        
        /* Header */
        .header-gradient {
            background: linear-gradient(to right, #9333ea, #ec4899);
            color: white;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
        }
        
        /* Überschriften und Buttons */
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.75rem;
        }
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: #2563eb;
            color: white;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s;
            border: none;
        }
        .btn:hover {
            background-color: #1d4ed8;
        }
        .btn-green {
            background-color: #22c55e;
        }
        .btn-green:hover {
            background-color: #16a34a;
        }
        .btn-red {
            background-color: #ef4444;
        }
        .btn-red:hover {
            background-color: #dc2626;
        }
        
        /* TÜV-Alarm */
        .tuev-alert {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background-color: #f59e0b;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            z-index: 10;
        }
        
        /* Wartungs-Button */
        .maintenance-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #22c55e;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            z-index: 10;
            border: none;
            cursor: pointer;
        }
        .maintenance-btn:hover {
            background-color: #16a34a;
        }
        
        /* Selects und Inputs */
        .custom-select {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            background-color: white;
            margin-bottom: 0.5rem;
        }
        .custom-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        /* Tabellen */
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        .custom-table th, 
        .custom-table td {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            text-align: left;
        }
        .custom-table th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .custom-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        /* Checkmarks */
        .check-complete {
            color: #16a34a;
        }
        .check-incomplete {
            color: #dc2626;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        /* Notification Banner */
        .notification {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            position: relative;
        }
        .notification-title {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 0.5rem;
        }
        .notification-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: #92400e;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container mx-auto max-w-4xl">
        <!-- Header -->
        <header>
            <h1 class="header-gradient">Fahrzeugpark Andy</h1>
            <div class="flex flex-wrap justify-between items-center mb-4">
                <div>
                    <label for="filter" class="font-semibold">Fahrzeugtyp:</label>
                    <select id="filter" class="custom-select">
                        <option value="Alle">Alle</option>
                        <option value="Auto">Auto</option>
                        <option value="Motorrad">Motorrad</option>
                        <option value="Roller">Roller</option>
                        <option value="Landmaschine">Landmaschine</option>
                        <option value="Anhänger">Anhänger</option>
                    </select>
                </div>
                <div>
                    <button id="history-btn" class="btn">Wartungshistorie</button>
                    <button id="notification-btn" class="btn ml-2">Benachrichtigungen</button>
                </div>
            </div>
        </header>

        <!-- TÜV-Erinnerungen (wird dynamisch angezeigt) -->
        <div id="tuev-notification" class="notification hidden">
            <button class="notification-close">&times;</button>
            <h3 class="notification-title">TÜV-Erinnerung</h3>
            <p class="mb-3">Die folgenden Fahrzeuge haben bald TÜV-Termine:</p>
            <ul id="tuev-list" class="space-y-2">
                <!-- TÜV-Einträge werden hier eingefügt -->
            </ul>
        </div>

        <!-- Fahrzeuge -->
        <main>
            <h2 class="section-title">Fahrzeuge</h2>
            <div id="vehicles-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Fahrzeuge werden hier eingefügt -->
            </div>

            <!-- Wartungsübersicht -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6 mt-8">
                <div class="flex flex-wrap justify-between items-center mb-3">
                    <h2 class="section-title mb-0">Übersicht: Anstehende Wartungen</h2>
                    <div>
                        <label for="year-select">Jahr:</label>
                        <select id="year-select" class="custom-select">
                            <!-- Jahre werden dynamisch hinzugefügt -->
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Fahrzeug</th>
                                <!-- Wartungsaufgaben werden dynamisch hinzugefügt -->
                                <th>TÜV</th>
                            </tr>
                        </thead>
                        <tbody id="maintenance-table">
                            <!-- Wartungsdaten werden hier eingefügt -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-right">
                    <button id="add-task-btn" class="btn btn-green">Wartungsdienst hinzufügen</button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-8 py-4 text-center text-gray-500 text-sm">
            <p>© 2025 Andys Fuhrpark - Alle Rechte vorbehalten</p>
            <p>Version 1.3.0</p>
        </footer>
    </div>

    <!-- MODALS -->
    
    <!-- Fahrzeugdetails Modal -->
    <div id="vehicle-detail-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="detail-title" class="text-2xl font-bold mb-4">Fahrzeugdetails</h2>
            
            <div class="mb-4">
                <img id="detail-image" src="" alt="" class="w-full h-64 object-contain border rounded bg-gray-100">
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block font-semibold mb-1">Marktpreis:</label>
                    <input id="detail-price" type="text" class="custom-input">
                </div>
                <div>
                    <label class="block font-semibold mb-1">Garage:</label>
                    <select id="detail-garage" class="custom-input">
                        <!-- Garagen werden dynamisch hinzugefügt -->
                    </select>
                </div>
                <div>
                    <label class="block font-semibold mb-1">TÜV-Termin:</label>
                    <input id="detail-tuev" type="date" class="custom-input">
                    <p id="tuev-warning" class="text-yellow-600 text-sm mt-1 hidden">
                        Dieser TÜV-Termin ist innerhalb des nächsten Monats fällig!
                    </p>
                </div>
                <div>
                    <label class="block font-semibold mb-1">Notizen:</label>
                    <textarea id="detail-note" class="custom-input h-24" placeholder="Notizen zum Fahrzeug..."></textarea>
                </div>
                <div>
                    <label class="block font-semibold mb-1">Foto ändern:</label>
                    <input id="detail-image-upload" type="file" accept="image/*" class="custom-input">
                </div>
                <button id="detail-save" class="btn btn-green w-full">Speichern und schließen</button>
            </div>
        </div>
    </div>

    <!-- Wartungsmodal -->
    <div id="maintenance-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="maintenance-title" class="text-2xl font-bold mb-4 text-blue-800">Wartung</h2>
            
            <div class="mb-4">
                <label class="mr-2 font-semibold">Jahr:</label>
                <select id="maintenance-year" class="custom-select">
                    <!-- Jahre werden dynamisch hinzugefügt -->
                </select>
            </div>
            
            <!-- Checkliste -->
            <div class="mb-6 bg-gray-50 p-4 rounded shadow">
                <h3 class="text-lg font-bold mb-3">Wartungstasks</h3>
                <ul id="maintenance-tasks" class="space-y-2">
                    <!-- Tasks werden dynamisch hinzugefügt -->
                </ul>
            </div>
            
            <!-- Neue Wartung eintragen -->
            <div class="mb-4 border-t pt-4">
                <h3 class="text-lg font-bold mb-2">Neue Wartung eintragen (optional)</h3>
                <div class="flex flex-col space-y-2">
                    <input id="new-maintenance-task" type="text" placeholder="Wartungsdienst beschreiben..." class="custom-input">
                    <input id="new-maintenance-date" type="date" class="custom-input">
                    <button id="add-maintenance-record" class="btn">Wartung hinzufügen &amp; schließen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Wartungshistorie Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-blue-800">Gesamte Wartungshistorie</h2>
            
            <div class="overflow-x-auto border rounded shadow">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Fahrzeug</th>
                            <th>Wartungsdienst</th>
                            <th>Art</th>
                        </tr>
                    </thead>
                    <tbody id="history-table">
                        <!-- Wartungshistorie wird dynamisch hinzugefügt -->
                    </tbody>
                </table>
            </div>
            
            <p id="no-history" class="text-center p-4 text-gray-500 hidden">
                Keine Wartungsdaten vorhanden
            </p>
        </div>
    </div>

    <script>
        // Überprüft, ob ein String einen Umlaut enthält
        function hasUmlauts(str) {
            return /[äöüÄÖÜß]/.test(str);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Grundlegende Daten
            const garages = [
                "Spexarder_Strasse",
                "Sparkasse_Avenwedde",
                "Mumprow",
                "Amrumweg"
            ];

            const initialVehicles = [
                {
                    id: "anhaenger-2004",
                    name: "Anhänger (2004)",
                    type: "Anhänger",
                    technical: "Nutzlastanhänger Baujahr 2004",
                    imageUrl: "./anhaenger.jpg",
                    marketPrice: "200€",
                    garage: "Mumprow",
                    note: "",
                    tuevDate: "",
                    specs: {
                        Motor: "Ohne",
                        Leistung: "-",
                        Baujahr: "2004",
                        Besonderheiten: "Nutzlast bis 750kg"
                    }
                },
                {
                    id: "mercedes-w113",
                    name: "Mercedes W113 230 SL (Pagode)",
                    type: "Auto",
                    technical: "Klassischer 230 SL mit 2,3-Liter Reihen-Sechszylinder und ca. 150 PS.",
                    imageUrl: "./Mercedes w113.jpeg",
                    marketPrice: "80.000€",
                    garage: "Spexarder_Strasse",
                    note: "",
                    tuevDate: "",
                    specs: {
                        Motor: "2,3L Reihen-Sechszylinder",
                        Leistung: "150 PS",
                        Baujahr: "1963",
                        Besonderheiten: "Ikonisches Pagoden-Design, zeitloses Erscheinungsbild"
                    }
                },
                {
                    id: "mercedes-r107",
                    name: "Mercedes R107 560 SL",
                    type: "Auto",
                    technical: "Luxuriöses Cabriolet mit 5,6-Liter V8 und ca. 230 PS.",
                    imageUrl: "./Mercedes R107.jpeg",
                    marketPrice: "30.000€",
                    garage: "Sparkasse_Avenwedde",
                    note: "",
                    tuevDate: "",
                    specs: {
                        Motor: "5,6L V8",
                        Leistung: "230 PS",
                        Baujahr: "1986",
                        Besonderheiten: "Hochkomfort, klassisches Design, luxuriöse Ausstattung"
                    }
                },
                {
                    id: "mercedes-r129",
                    name: "Mercedes R129 SL",
                    type: "Auto",
                    technical: "Sportlicher Roadster mit modernster Technik und elegantem Design.",
                    imageUrl: "./Mercedes R129.jpeg",
                    marketPrice: "25.000€",
                    garage: "Spexarder_Strasse",
                    note: "",
                    tuevDate: "",
                    specs: {
                        Motor: "3,0L V6",
                        Leistung: "320 PS",
                        Baujahr: "1993",
                        Besonderheiten: "Hydraulisches Verdeck, automatischer Überrollbügel"
                    }
                },
                {
                    id: "mercedes-clk",
                    name: "Mercedes CLK Cabrio",
                    type: "Auto",
                    technical: "Elegantes Cabriolet mit sportlichem Charakter.",
                    imageUrl: "./Mervedes CLK 208.jpeg",
                    marketPrice: "12.000€",
                    garage: "Sparkasse_Avenwedde",
                    note: "",
                    tuevDate: "",
                    specs: {
                        Motor: "3,2L V6",
                        Leistung: "198 PS",
                        Baujahr: "2005",
                        Besonderheiten: "Elektrisches Verdeck, Lederausstattung"
                    }
                },
                {
                    id: "vw-t6",
                    name: "VW T6 Multivan",
                    type: "Auto",
                    technical: "Vielseitiger Transporter mit Wohnmobilausstattung.",
                    imageUrl: "./VW T6.jpeg",
                    marketPrice: "18.000€",
                    garage: "Mumprow",
                    note: "",
                    tuevDate: "",
                    specs: {
                        Motor: "2,0L TDI",
                        Leistung: "150 PS",
                        Baujahr: "2019",
                        Besonderheiten: "Campingausbau, Aufstelldach, Küche"
                    }
                },
                {
                    id: "man-traktor-201",
                    name: "MAN Traktor 201",
                    type: "Landmaschine",
                    technical: "Klassischer Traktor für Feldarbeiten und leichte Transportaufgaben.",
                    imageUrl: "./MAN-Traktor.jpeg",
                    marketPrice: "4.500€",
                    garage: "Amrumweg",
                    note: "",
                    tuevDate: "",
                    specs: {
                        Motor: "2,8L Diesel",
                        Leistung: "28 PS",
                        Baujahr: "1963",
                        Besonderheiten: "Restaurierter Zustand, Originalteile"
                    }
                }
            ];

            const defaultMaintenanceTasks = [
                "Ölwechsel", 
                "Zündkerzen prüfen", 
                "Bremsen kontrollieren", 
                "Reifendruck prüfen"
            ];

            // Daten aus dem Local Storage laden oder Standardwerte verwenden
            let vehicles = JSON.parse(localStorage.getItem('vehicles')) || initialVehicles;
            let maintenanceTasks = JSON.parse(localStorage.getItem('maintenanceTasks')) || defaultMaintenanceTasks;
            let maintenanceData = JSON.parse(localStorage.getItem('maintenanceData')) || {};
            let maintenanceRecords = JSON.parse(localStorage.getItem('maintenanceRecords')) || {};

            // DOM-Elemente
            const vehiclesContainer = document.getElementById('vehicles-container');
            const filterSelect = document.getElementById('filter');
            const yearSelect = document.getElementById('year-select');
            const maintenanceTable = document.getElementById('maintenance-table');
            const maintenanceTasksContainer = document.getElementById('maintenance-tasks');
            const historyTable = document.getElementById('history-table');
            const tuevNotification = document.getElementById('tuev-notification');
            const tuevList = document.getElementById('tuev-list');

            // Modals
            const vehicleDetailModal = document.getElementById('vehicle-detail-modal');
            const maintenanceModal = document.getElementById('maintenance-modal');
            const historyModal = document.getElementById('history-modal');

            // Modal-Elemente
            const detailTitle = document.getElementById('detail-title');
            const detailImage = document.getElementById('detail-image');
            const detailPrice = document.getElementById('detail-price');
            const detailGarage = document.getElementById('detail-garage');
            const detailTuev = document.getElementById('detail-tuev');
            const tuevWarning = document.getElementById('tuev-warning');
            const detailNote = document.getElementById('detail-note');
            const detailSave = document.getElementById('detail-save');

            // Wartungsmodal-Elemente
            const maintenanceTitle = document.getElementById('maintenance-title');
            const maintenanceYear = document.getElementById('maintenance-year');
            const newMaintenanceTask = document.getElementById('new-maintenance-task');
            const newMaintenanceDate = document.getElementById('new-maintenance-date');
            const addMaintenanceRecord = document.getElementById('add-maintenance-record');

            // Buttons
            const historyBtn = document.getElementById('history-btn');
            const addTaskBtn = document.getElementById('add-task-btn');
            const notificationBtn = document.getElementById('notification-btn');

            // Aktuell ausgewähltes Fahrzeug und Jahr
            let selectedVehicleId = null;
            let selectedYear = new Date().getFullYear();

            // Jahren in Dropdowns hinzufügen
            function populateYears() {
                yearSelect.innerHTML = '';
                maintenanceYear.innerHTML = '';
                
                const currentYear = new Date().getFullYear();
                for (let i = 0; i < 25; i++) {
                    const year = currentYear + i;
                    
                    // Für Haupttabelle
                    const yearOption = document.createElement('option');
                    yearOption.value = year;
                    yearOption.textContent = year;
                    yearSelect.appendChild(yearOption);
                    
                    // Für Wartungsmodal
                    const modalYearOption = document.createElement('option');
                    modalYearOption.value = year;
                    modalYearOption.textContent = year;
                    maintenanceYear.appendChild(modalYearOption);
                }
                
                // Standardjahr auswählen
                yearSelect.value = selectedYear;
                maintenanceYear.value = selectedYear;
            }

            // Garagen in Dropdown hinzufügen
            function populateGarages() {
                detailGarage.innerHTML = '';
                
                garages.forEach(garage => {
                    const option = document.createElement('option');
                    option.value = garage;
                    option.textContent = garage.replace(/_/g, ' ');
                    detailGarage.appendChild(option);
                });
            }

            // Prüft, ob der TÜV in einem Monat fällig ist
            function isTuevDueSoon(tuevDate) {
                if (!tuevDate) return false;
                
                const today = new Date();
                const tuev = new Date(tuevDate);
                
                // Setze Vergleichsdatum auf 1 Monat in der Zukunft
                const oneMonthLater = new Date();
                oneMonthLater.setMonth(today.getMonth() + 1);
                
                // TÜV ist fällig, wenn das Datum zwischen heute und in einem Monat liegt
                return tuev >= today && tuev <= oneMonthLater;
            }

            // Email-Link für TÜV-Erinnerungen erstellen
            function createTuevEmailLink(vehicle) {
                const subject = `TÜV-Erinnerung: ${vehicle.name}`;
                const body = `Der TÜV für Ihr Fahrzeug ${vehicle.name} ist am ${new Date(vehicle.tuevDate).toLocaleDateString()} fällig.`;
                return `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            }

            // TÜV-Erinnerungen anzeigen
            function showTuevReminders() {
                const dueSoonVehicles = vehicles.filter(vehicle => vehicle.tuevDate && isTuevDueSoon(vehicle.tuevDate));
                
                if (dueSoonVehicles.length > 0) {
                    tuevList.innerHTML = '';
                    
                    dueSoonVehicles.forEach(vehicle => {
                        const li = document.createElement('li');
                        li.className = 'flex flex-col md:flex-row md:justify-between md:items-center';
                        li.innerHTML = `
                            <div>
                                <span class="font-semibold">${vehicle.name}:</span>
                                <span class="text-yellow-700">
                                    ${new Date(vehicle.tuevDate).toLocaleDateString()}
                                </span>
                            </div>
                            <div class="mt-1 md:mt-0">
                                <a href="${createTuevEmailLink(vehicle)}" 
                                   class="text-blue-600 hover:text-blue-800 underline text-sm md:ml-4"
                                   target="_blank" rel="noopener noreferrer">
                                    E-Mail-Erinnerung senden
                                </a>
                            </div>
                        `;
                        tuevList.appendChild(li);
                    });
                    
                    tuevNotification.classList.remove('hidden');
                } else {
                    tuevNotification.classList.add('hidden');
                }
            }

            // Fahrzeuge anzeigen
            function displayVehicles(vehiclesToShow) {
                console.log("displayVehicles aufgerufen mit", vehiclesToShow.length, "Fahrzeugen");
                vehiclesContainer.innerHTML = '';
                
                if(vehiclesToShow.length === 0) {
                    vehiclesContainer.innerHTML = '<p class="text-center p-4 col-span-3">Keine Fahrzeuge gefunden.</p>';
                    return;
                }
                
                vehiclesToShow.forEach(vehicle => {
                    const card = document.createElement('div');
                    card.className = 'vehicle-card';
                    card.setAttribute('data-id', vehicle.id);
                    
                    // Fallback für Bilder
                    const imgSrc = vehicle.imageUrl || '';
                    const isTuevSoon = vehicle.tuevDate && isTuevDueSoon(vehicle.tuevDate);
                    
                    card.innerHTML = `
                        ${isTuevSoon ? '<div class="tuev-alert">TÜV!</div>' : ''}
                        <button class="maintenance-btn" data-id="${vehicle.id}">Wartung</button>
                        <div class="vehicle-img-container">
                            <img src="${imgSrc}" alt="${vehicle.name}" class="vehicle-img" 
                                 onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100%\\' height=\\'100%\\' viewBox=\\'0 0 24 24\\'><rect width=\\'24\\' height=\\'24\\' fill=\\%23f3f4f6\\/><path fill=\\%23cccccc\\ d=\\'M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\\'/></svg>'">
                        </div>
                        <h3 class="text-xl font-bold mt-2 text-blue-800">${vehicle.name}</h3>
                        <p class="text-sm text-gray-700">${vehicle.technical}</p>
                        <div class="mt-2 text-sm text-gray-800">
                            <p><strong>Motor:</strong> ${vehicle.specs?.Motor || "N/A"}</p>
                            <p><strong>Leistung:</strong> ${vehicle.specs?.Leistung || "N/A"}</p>
                            <p><strong>Baujahr:</strong> ${vehicle.specs?.Baujahr || "N/A"}</p>
                            <p><strong>Besonderheiten:</strong> ${vehicle.specs?.Besonderheiten || "N/A"}</p>
                        </div>
                        <div class="mt-2 text-sm">
                            <p><strong>Marktpreis:</strong> ${vehicle.marketPrice}</p>
                            <p><strong>Garage:</strong> ${vehicle.garage?.replace(/_/g, " ")}</p>
                            ${vehicle.tuevDate ? `
                                <p class="${isTuevSoon ? 'font-bold text-yellow-700' : ''}">
                                    <strong>TÜV:</strong> ${new Date(vehicle.tuevDate).toLocaleDateString()}
                                    ${isTuevSoon ? ' (bald fällig!)' : ''}
                                </p>
                            ` : ''}
                        </div>
                    `;
                    
                    vehiclesContainer.appendChild(card);
                    
                    // Click-Event für Wartungsbutton
                    const maintenanceBtn = card.querySelector('.maintenance-btn');
                    maintenanceBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        openMaintenanceModal(vehicle.id);
                    });
                    
                    // Click-Event für Fahrzeugdetails
                    card.addEventListener('click', function() {
                        openVehicleDetailModal(vehicle.id);
                    });
                });
            }

            // Wartungstabelle anzeigen
            function displayMaintenanceTable() {
                const tableHead = document.querySelector('.custom-table thead tr');
                tableHead.innerHTML = '<th>Fahrzeug</th>';
                
                // Wartungstasks als Spalten hinzufügen
                maintenanceTasks.forEach(task => {
                    const th = document.createElement('th');
                    th.textContent = task;
                    tableHead.appendChild(th);
                });
                
                // TÜV-Spalte hinzufügen
                const tuevTh = document.createElement('th');
                tuevTh.textContent = 'TÜV';
                tableHead.appendChild(tuevTh);
                
                // Tabellenkörper leeren
                maintenanceTable.innerHTML = '';
                
                // Für jedes gefilterte Fahrzeug eine Zeile erstellen
                const filteredVehicles = getFilteredVehicles();
                filteredVehicles.forEach(vehicle => {
                    const row = document.createElement('tr');
                    
                    // Fahrzeugname
                    const nameCell = document.createElement('td');
                    nameCell.className = 'font-medium';
                    nameCell.textContent = vehicle.name;
                    row.appendChild(nameCell);
                    
                    // Wartungsstatus für jede Aufgabe
                    maintenanceTasks.forEach(task => {
                        const taskCell = document.createElement('td');
                        taskCell.className = 'text-center';
                        
                        const vehicleMaintenanceData = maintenanceData[vehicle.id] || {};
                        const yearData = vehicleMaintenanceData[selectedYear] || {};
                        const isComplete = !!yearData[task];
                        
                        taskCell.innerHTML = `<span class="${isComplete ? 'check-complete' : 'check-incomplete'}">${isComplete ? '✓' : '✗'}</span>`;
                        row.appendChild(taskCell);
                    });
                    
                    // TÜV-Status
                    const tuevCell = document.createElement('td');
                    tuevCell.className = 'text-center';
                    
                    if (vehicle.tuevDate) {
                        const isTuevSoon = isTuevDueSoon(vehicle.tuevDate);
                        tuevCell.innerHTML = `<span class="${isTuevSoon ? 'font-bold text-yellow-700' : ''}">${new Date(vehicle.tuevDate).toLocaleDateString()}</span>`;
                    } else {
                        tuevCell.innerHTML = '<span class="text-gray-400">Nicht eingetragen</span>';
                    }
                    row.appendChild(tuevCell);
                    
                    maintenanceTable.appendChild(row);
                });
            }

            // Wartungsaufgaben im Modal anzeigen
            function displayMaintenanceTasks(vehicleId) {
                maintenanceTasksContainer.innerHTML = '';
                
                maintenanceTasks.forEach(task => {
                    const vehicleMaintenanceData = maintenanceData[vehicleId] || {};
                    const yearData = vehicleMaintenanceData[selectedYear] || {};
                    const completedDate = yearData[task];
                    
                    const li = document.createElement('li');
                    li.className = 'flex items-center';
                    li.innerHTML = `
                        <input type="checkbox" ${completedDate ? 'checked' : ''} 
                               class="mr-3 h-5 w-5" data-task="${task}">
                        <span class="${completedDate ? 'line-through text-green-600' : ''}">
                            ${task}
                        </span>
                        ${completedDate ? `
                            <span class="ml-2 text-sm text-green-600">
                                (am ${new Date(completedDate).toLocaleDateString()})
                            </span>
                        ` : ''}
                    `;
                    
                    // Checkbox-Event
                    const checkbox = li.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        toggleMaintenanceTask(vehicleId, selectedYear, task);
                    });
                    
                    maintenanceTasksContainer.appendChild(li);
                });
            }

            // Wartungshistorie anzeigen
            function displayMaintenanceHistory() {
                historyTable.innerHTML = '';
                const allEntries = [];
                
                // Checkbox-basierte Wartungen
                Object.entries(maintenanceData).forEach(([vehicleId, yearData]) => {
                    const vehicle = vehicles.find(v => v.id === vehicleId);
                    if (!vehicle) return;
                    
                    Object.entries(yearData).forEach(([year, tasks]) => {
                        Object.entries(tasks).forEach(([taskName, completedDate]) => {
                            if (completedDate) {
                                allEntries.push({
                                    vehicleId,
                                    vehicleName: vehicle.name,
                                    year,
                                    task: taskName,
                                    date: new Date(completedDate),
                                    type: "Standard"
                                });
                            }
                        });
                    });
                });
                
                // Manuelle Wartungseinträge
                Object.entries(maintenanceRecords).forEach(([vehicleId, records]) => {
                    const vehicle = vehicles.find(v => v.id === vehicleId);
                    if (!vehicle) return;
                    
                    records.forEach(record => {
                        allEntries.push({
                            vehicleId,
                            vehicleName: vehicle.name,
                            task: record.task,
                            date: new Date(record.date),
                            type: "Manuell"
                        });
                    });
                });
                
                // Sortieren (neueste zuerst)
                allEntries.sort((a, b) => b.date - a.date);
                
                // Keine Einträge?
                if (allEntries.length === 0) {
                    document.getElementById('no-history').classList.remove('hidden');
                } else {
                    document.getElementById('no-history').classList.add('hidden');
                    
                    // Tabelle befüllen
                    allEntries.forEach((entry, index) => {
                        const row = document.createElement('tr');
                        row.className = index % 2 === 0 ? 'bg-gray-50' : '';
                        
                        row.innerHTML = `
                            <td>${entry.date.toLocaleDateString()}</td>
                            <td>${entry.vehicleName}</td>
                            <td>${entry.task}</td>
                            <td>${entry.type}</td>
                        `;
                        
                        historyTable.appendChild(row);
                    });
                }
            }

            // Gefilterte Fahrzeuge bekommen
            function getFilteredVehicles() {
                const selectedType = filterSelect.value;
                console.log("Filter ausgewählt:", selectedType);
                console.log("Verfügbare Fahrzeugtypen:", [...new Set(vehicles.map(v => v.type))]);
                
                // Prüft, ob der Typ Umlaute enthält, da diese Probleme verursachen könnten
                if (hasUmlauts(selectedType)) {
                    console.log("Achtung: Der Filtertyp enthält Umlaute, was zu Problemen führen könnte");
                }
                
                if (selectedType === 'Alle') {
                    return vehicles;
                } else {
                    // Statt auf exakte Gleichheit zu prüfen, prüfen wir, ob es enthält oder normalisiert gleich ist
                    const filtered = vehicles.filter(vehicle => {
                        const vehicleType = vehicle.type || '';
                        const typesMatch = vehicleType === selectedType || 
                                         vehicleType.includes(selectedType) || 
                                         selectedType.includes(vehicleType);
                        
                        console.log(`Fahrzeug ${vehicle.name} hat Typ ${vehicleType}, Übereinstimmung mit ${selectedType}: ${typesMatch}`);
                        return typesMatch;
                    });
                    
                    console.log(`Gefilterte Fahrzeuge für Typ '${selectedType}':`, filtered.length);
                    return filtered;
                }
            }

            // Fahrzeug-Details-Modal öffnen
            function openVehicleDetailModal(vehicleId) {
                const vehicle = vehicles.find(v => v.id === vehicleId);
                if (!vehicle) return;
                
                selectedVehicleId = vehicleId;
                
                // Modal-Inhalte befüllen
                detailTitle.textContent = vehicle.name;
                detailImage.src = vehicle.imageUrl || '';
                detailImage.alt = vehicle.name;
                detailPrice.value = vehicle.marketPrice || '';
                detailGarage.value = vehicle.garage || '';
                detailNote.value = vehicle.note || '';
                
                // TÜV-Datum formatieren
                if (vehicle.tuevDate) {
                    const date = new Date(vehicle.tuevDate);
                    detailTuev.value = date.toISOString().split('T')[0];
                    
                    // TÜV-Warnung anzeigen, wenn nötig
                    if (isTuevDueSoon(vehicle.tuevDate)) {
                        tuevWarning.classList.remove('hidden');
                    } else {
                        tuevWarning.classList.add('hidden');
                    }
                } else {
                    detailTuev.value = '';
                    tuevWarning.classList.add('hidden');
                }
                
                // Modal öffnen
                vehicleDetailModal.classList.add('active');
            }

            // Wartungsmodal öffnen
            function openMaintenanceModal(vehicleId) {
                const vehicle = vehicles.find(v => v.id === vehicleId);
                if (!vehicle) return;
                
                selectedVehicleId = vehicleId;
                
                // Modal-Inhalte befüllen
                maintenanceTitle.textContent = `Wartung: ${vehicle.name}`;
                maintenanceYear.value = selectedYear;
                newMaintenanceTask.value = '';
                newMaintenanceDate.value = '';
                
                // Wartungstasks anzeigen
                displayMaintenanceTasks(vehicleId);
                
                // Modal öffnen
                maintenanceModal.classList.add('active');
            }

            // Wartungshistorie-Modal öffnen
            function openHistoryModal() {
                displayMaintenanceHistory();
                historyModal.classList.add('active');
            }

            // Modals schließen
            function closeModals() {
                vehicleDetailModal.classList.remove('active');
                maintenanceModal.classList.remove('active');
                historyModal.classList.remove('active');
            }

            // Wartungsaufgabe umschalten
            function toggleMaintenanceTask(vehicleId, year, task) {
                // Aktuellen Status bekommen
                const vehicleData = maintenanceData[vehicleId] || {};
                const yearData = vehicleData[year] || {};
                const currentStatus = yearData[task];
                
                // Status umschalten
                const newYearData = {
                    ...yearData,
                    [task]: currentStatus ? null : new Date().toISOString()
                };
                
                // Daten aktualisieren
                maintenanceData = {
                    ...maintenanceData,
                    [vehicleId]: {
                        ...vehicleData,
                        [year]: newYearData
                    }
                };
                
                // Wartungstasks anzeigen und speichern
                displayMaintenanceTasks(vehicleId);
                displayMaintenanceTable();
                saveData();
            }

            // Neue manuelle Wartungsaufzeichnung hinzufügen
            function addMaintenanceRecordEntry(vehicleId) {
                const task = newMaintenanceTask.value.trim();
                const date = newMaintenanceDate.value;
                
                if (task && date) {
                    const record = {
                        task,
                        date,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Records für das Fahrzeug bekommen oder erstellen
                    const currentRecords = maintenanceRecords[vehicleId] || [];
                    
                    // Daten aktualisieren
                    maintenanceRecords = {
                        ...maintenanceRecords,
                        [vehicleId]: [...currentRecords, record]
                    };
                    
                    // Wartungstabelle aktualisieren und speichern
                    displayMaintenanceTable();
                    saveData();
                    
                    // Modal schließen
                    closeModals();
                }
            }

            // Neue Wartungsaufgabe hinzufügen
            function addMaintenanceTask() {
                const newTask = prompt("Neuen Wartungsdienst eingeben:");
                if (newTask && newTask.trim() && !maintenanceTasks.includes(newTask.trim())) {
                    maintenanceTasks.push(newTask.trim());
                    displayMaintenanceTable();
                    saveData();
                }
            }

            // Fahrzeugdaten aktualisieren
            function updateVehicleData() {
                if (!selectedVehicleId) return;
                
                // Fahrzeug finden
                const vehicleIndex = vehicles.findIndex(v => v.id === selectedVehicleId);
                if (vehicleIndex === -1) return;
                
                // Daten aktualisieren
                vehicles[vehicleIndex] = {
                    ...vehicles[vehicleIndex],
                    marketPrice: detailPrice.value,
                    garage: detailGarage.value,
                    note: detailNote.value,
                    tuevDate: detailTuev.value
                };
                
                // Anzeige aktualisieren und speichern
                displayVehicles(getFilteredVehicles());
                displayMaintenanceTable();
                showTuevReminders();
                saveData();
                
                // Modal schließen
                closeModals();
            }

            // Bild hochladen
            document.getElementById('detail-image-upload').addEventListener('change', function(e) {
                if (!selectedVehicleId) return;
                
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Fahrzeug finden
                    const vehicleIndex = vehicles.findIndex(v => v.id === selectedVehicleId);
                    if (vehicleIndex === -1) return;
                    
                    // Bild aktualisieren
                    vehicles[vehicleIndex].imageUrl = event.target.result;
                    
                    // Vorschau aktualisieren
                    detailImage.src = event.target.result;
                    
                    // Speichern
                    saveData();
                };
                reader.readAsDataURL(file);
            });

            // Daten speichern
            function saveData() {
                try {
                    localStorage.setItem('vehicles', JSON.stringify(vehicles));
                    localStorage.setItem('maintenanceTasks', JSON.stringify(maintenanceTasks));
                    localStorage.setItem('maintenanceData', JSON.stringify(maintenanceData));
                    localStorage.setItem('maintenanceRecords', JSON.stringify(maintenanceRecords));
                    console.log('Daten gespeichert');
                } catch (error) {
                    console.error('Fehler beim Speichern der Daten:', error);
                    alert('Fehler beim Speichern der Daten. Möglicherweise ist Ihr Speicherplatz voll.');
                }
            }

            // Event-Listener
            
            // Filter-Änderung - direktes Filtern ohne komplexe Funktionen
            filterSelect.addEventListener('change', function() {
                const selectedType = this.value;
                console.log("Filter geändert zu:", selectedType);
                
                let filtered;
                if (selectedType === 'Alle') {
                    filtered = vehicles;
                } else {
                    filtered = vehicles.filter(v => v.type === selectedType);
                    console.log(`Fahrzeuge mit Typ "${selectedType}":`, filtered.map(v => v.name));
                }
                
                console.log("Anzahl gefilterter Fahrzeuge:", filtered.length);
                displayVehicles(filtered);
                displayMaintenanceTable();
            });
            
            // Jahr-Änderung in Haupttabelle
            yearSelect.addEventListener('change', function() {
                selectedYear = parseInt(this.value);
                displayMaintenanceTable();
            });
            
            // Jahr-Änderung im Wartungsmodal
            maintenanceYear.addEventListener('change', function() {
                selectedYear = parseInt(this.value);
                displayMaintenanceTasks(selectedVehicleId);
            });
            
            // TÜV-Datum-Änderung im Detailmodal
            detailTuev.addEventListener('change', function() {
                const date = this.value ? new Date(this.value) : null;
                if (date && isTuevDueSoon(date)) {
                    tuevWarning.classList.remove('hidden');
                } else {
                    tuevWarning.classList.add('hidden');
                }
            });
            
            // Buttons
            historyBtn.addEventListener('click', openHistoryModal);
            addTaskBtn.addEventListener('click', addMaintenanceTask);
            detailSave.addEventListener('click', updateVehicleData);
            addMaintenanceRecord.addEventListener('click', function() {
                addMaintenanceRecordEntry(selectedVehicleId);
            });
            
            // Schließen-Buttons für Modals
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', closeModals);
            });
            
            // Overlay-Klick zum Schließen
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModals();
                    }
                });
            });
            
            // TÜV-Notification schließen
            document.querySelector('.notification-close').addEventListener('click', function() {
                tuevNotification.classList.add('hidden');
            });
            
            // Benachrichtigungen-Button
            notificationBtn.addEventListener('click', function() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(function(permission) {
                        if (permission === 'granted') {
                            alert('Benachrichtigungen sind aktiviert.');
                        }
                    });
                }
            });
            
            // Fehlerhafte Fahrzeuge korrigieren
            vehicles.forEach(vehicle => {
                if (vehicle.type === "Anhänger" && hasUmlauts(vehicle.type)) {
                    console.log(`Korrigiere Typ für ${vehicle.name} von ${vehicle.type} zu 'Anhänger'`);
                    // Manchmal werden Umlaute falsch codiert - stellen wir sicher, dass sie korrekt sind
                    vehicle.type = "Anhänger";
                }
            });
            
            // Initialisierung
            populateYears();
            populateGarages();
            
            // Debug-Ausgabe für Fahrzeugtypen
            console.log("Alle Fahrzeuge:", vehicles);
            console.log("Fahrzeugtypen in Daten:", vehicles.map(v => v.type));
            console.log("Filter-Optionen:", Array.from(filterSelect.options).map(o => o.value));
            
            // Wir sehen uns speziell den Anhänger an
            const anhaenger = vehicles.find(v => v.id === "anhaenger-2004");
            if (anhaenger) {
                console.log("Anhänger-Fahrzeug gefunden:", anhaenger);
                console.log("Anhänger Typ:", anhaenger.type);
                console.log("Umlaute im Typ?", hasUmlauts(anhaenger.type));
            } else {
                console.log("FEHLER: Anhänger nicht gefunden!");
            }
            
            displayVehicles(getFilteredVehicles());
            displayMaintenanceTable();
            showTuevReminders();
            
            console.log('App initialisiert');
        });
    </script>
</body>
</html>
